<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ø­Ù„ÙˆØ§Ù†ÙŠ Ø§Ù„Ø¹Ù…Ø¯Ù‡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    * { box-sizing: border-box; }
    body { background-color: #111; color: gold; font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    .section-btn {
        font-size: 22px; padding: 18px 0; width: 100%;
        border-radius: 12px; margin: 15px auto;
        background-color: gold; color: #111;
        border: none; display: block; cursor: pointer;
    }
    .form-section {
        display: none; background-color: #222;
        margin-top: 10px; padding: 15px; border-radius: 10px;
    }
    input, button, select {
        width: 100%; padding: 14px; margin: 5px 0;
        border-radius: 6px; border: none; font-size: 18px;
    }
    .label { margin-top: 10px; display: block; color: #ffc; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; color: gold; }
    th, td { border: 1px solid #444; padding: 8px; text-align: center; }
    th { background-color: #333; }
    td { background-color: #222; }
    button.delete-btn { background: none; border: none; color: red; font-size: 20px; cursor: pointer; }
</style>
</head>
<body>
<h1>ğŸ°Ø­Ù„ÙˆØ§Ù†ÙŠ Ø§Ù„Ø¹Ù…Ø¯Ù‡</h1>

<!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<button class="section-btn" onclick="toggleSection('customers')">ğŸ“‹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
<div class="form-section" id="customers">
    <label class="label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
    <input id="cust_name" type="text"/>
    <label class="label">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (+ Ø£Ùˆ -)</label>
    <input id="cust_trays" type="number"/>
    <button onclick="saveCustomer()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <div id="customerList"></div>
</div>

<!-- Ø§Ù„ØªÙˆØ²ÙŠØ¹ -->
<button class="section-btn" onclick="toggleSection('outgoing')">ğŸ“¦ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
<div class="form-section" id="outgoing">
    <label class="label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ</label>
    <input id="out_trays" type="number"/>
    <button onclick="saveOutgoing()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
    <div id="outgoingList"></div>
</div>

<!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹ -->
<button class="section-btn" onclick="toggleSection('outgoingReports')">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
<div class="form-section" id="outgoingReports">
    <div id="outgoingReportsContent"></div>
</div>

<!-- Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¹ -->
<button class="section-btn" onclick="toggleSection('pos')">ğŸ§¾ Ù†Ù‚Ø·Ø© Ø¨ÙŠØ¹</button>
<div class="form-section" id="pos">
    <label class="label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
    <select id="pos_customer"></select>
    <label class="label">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</label>
    <input id="pos_trays" type="number"/>
    <label class="label">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§Ø±Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</label>
    <input id="pos_empty" type="number"/>
    <label class="label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù‚Ø§Ø¦Ù… (ÙƒØ¬Ù…)</label>
    <input id="pos_gross" type="number" step="0.01"/>
    <label class="label">Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ (ÙƒØ¬Ù…)</label>
    <input id="pos_net" type="number" step="0.01"/>
    <label class="label">Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ (Ø¬Ù†ÙŠÙ‡)</label>
    <input id="pos_price" type="number" step="0.01"/>
    <p id="pos_diff" style="color:lightgreen"></p>
    <button onclick="calcInvoice()">ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <p id="pos_total" style="font-weight:bold"></p>
    <button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
    <div id="invoiceList"></div>
</div>

<!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<button class="section-btn" onclick="toggleSection('customerReports')">ğŸ“‘ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
<div class="form-section" id="customerReports">
    <div id="customerReportsContent"></div>
</div>

<!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙˆØ§Ù†ÙŠ Ø§Ù„ÙÙˆØ§Ø±Øº -->
<button class="section-btn" onclick="toggleSection('emptyTrays')">ğŸ¥£ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙˆØ§Ù†ÙŠ Ø§Ù„ÙÙˆØ§Ø±Øº Ù„Ù„ÙŠÙˆÙ…</button>
<div class="form-section" id="emptyTrays">
    <div id="emptyTraysContent"></div>
</div>

<!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
<button class="section-btn" onclick="toggleSection('sales')">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
<div class="form-section" id="sales">
    <div id="salesContent"></div>
</div>

<script>
let customers = JSON.parse(localStorage.getItem("customers") || "[]");
let outgoing = JSON.parse(localStorage.getItem("outgoing") || "[]");
let invoices = JSON.parse(localStorage.getItem("invoices") || "[]");

const toggleSection = id => {
    let sec = document.getElementById(id);
    let isVisible = sec.style.display === 'block';
    document.querySelectorAll('.form-section').forEach(s => s.style.display = 'none');
    if (!isVisible) {
        sec.style.display = 'block';
        if(id==='customers') showCustomers();
        if(id==='outgoing') showOutgoing();
        if(id==='outgoingReports') showOutgoingReports();
        if(id==='pos') loadCustomers(pos_customer), showInvoices();
        if(id==='customerReports') showCustomerReports();
        if(id==='emptyTrays') showEmptyTrays();
        if(id==='sales') showSales();
    }
};

const loadCustomers = (selectElem) => {
    selectElem.innerHTML = customers.map(c=>`<option>${c.name}</option>`).join("");
}

// Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
const saveCustomer = () => {
    customers.push({
        name: cust_name.value,
        trays: parseInt(cust_trays.value)||0
    });
    localStorage.setItem("customers", JSON.stringify(customers));
    showCustomers();
}
const showCustomers = () => {
    if(customers.length===0) return customerList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡.</p>";
    customerList.innerHTML = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø±ØµÙŠØ¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ</th><th>Ø­Ø°Ù</th></tr>`+
        customers.map((c,i)=>`<tr><td>${c.name}</td><td>${c.trays}</td><td><button class='delete-btn' onclick='deleteCustomer(${i})'>âŒ</button></td></tr>`).join("")+`</table>`;
}
const deleteCustomer = i => {
    customers.splice(i,1);
    localStorage.setItem("customers", JSON.stringify(customers));
    showCustomers();
}

// Ø§Ù„ØªÙˆØ²ÙŠØ¹
const saveOutgoing = () => {
    let traysNum = parseInt(out_trays.value);
    outgoing.push({trays: traysNum, date: new Date().toLocaleDateString('ar-EG')});
    localStorage.setItem("outgoing", JSON.stringify(outgoing));
    showOutgoing();
}
const showOutgoing = () => {
    if(outgoing.length===0) return outgoingList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆØ²ÙŠØ¹.</p>";
    outgoingList.innerHTML = `<table><tr><th>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr>`+
        outgoing.map((o,i)=>`<tr><td>${o.trays}</td><td>${o.date}</td><td><button class='delete-btn' onclick='deleteOutgoing(${i})'>âŒ</button></td></tr>`).join("")+`</table>`;
}
const deleteOutgoing = i => {
    outgoing.splice(i,1);
    localStorage.setItem("outgoing", JSON.stringify(outgoing));
    showOutgoing();
}

// ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹
const showOutgoingReports = () => {
    if(outgoing.length===0) return outgoingReportsContent.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± ØªÙˆØ²ÙŠØ¹.</p>";
    let outgoingByDate = {};
    outgoing.forEach(o => { outgoingByDate[o.date] = (outgoingByDate[o.date] || 0) + o.trays; });
    let salesByDate = {};
    invoices.forEach(inv => { salesByDate[inv.date] = (salesByDate[inv.date] || 0) + inv.trays; });
    let rows = Object.keys(outgoingByDate).map(date => {
        let totalOut = outgoingByDate[date];
        let totalSold = salesByDate[date] || 0;
        let remaining = totalOut - totalSold;
        return `<tr><td>${date}</td><td>${totalOut}</td><td>${totalSold}</td><td>${remaining}</td></tr>`;
    }).join("");
    outgoingReportsContent.innerHTML = `<table><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØªÙˆØ²ÙŠØ¹</th><th>Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th></tr>${rows}</table>`;
}

// Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
let currentInvoice = {};
const calcInvoice = () => {
    let gross = parseFloat(pos_gross.value)||0;
    let net = parseFloat(pos_net.value)||0;
    let price = parseFloat(pos_price.value)||0;
    let diff = gross - net;
    let total = net * price;
    pos_diff.innerText = `ÙØ±Ù‚ Ø§Ù„Ù…ÙŠØ²Ø§Ù†: ${diff.toFixed(2)} ÙƒØ¬Ù…`;
    pos_total.innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
    currentInvoice = {
        customer: pos_customer.value,
        trays: parseInt(pos_trays.value) || 0,
        empty: parseInt(pos_empty.value)||0,
        gross, net, diff, price, total,
        date: new Date().toLocaleDateString('ar-EG')
    };
}

const saveInvoice = () => {
    if(!currentInvoice.customer) return alert("Ø§Ø­Ø³Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§");

    let custIndex = customers.findIndex(c => c.name === currentInvoice.customer);
    if (custIndex !== -1) {
        customers[custIndex].trays =
            (customers[custIndex].trays || 0)
            - (currentInvoice.trays || 0)
            + (currentInvoice.empty || 0);
    }

    invoices.push(currentInvoice);
    localStorage.setItem("customers", JSON.stringify(customers));
    localStorage.setItem("invoices", JSON.stringify(invoices));
    showInvoices();
    showCustomerReports();
}

const showInvoices = () => {
    if(invoices.length===0) return invoiceList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±.</p>";
    invoiceList.innerHTML = `<table><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØµÙˆØ§Ù†ÙŠ</th><th>Ø§Ù„ÙÙˆØ§Ø±Øº</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr>`+
        invoices.map((inv,i)=>`<tr><td>${inv.customer}</td><td>${inv.trays}</td><td>${inv.empty}</td><td>${inv.gross}</td><td>${inv.net}</td><td>${inv.price}</td><td>${inv.diff}</td><td>${inv.total}</td><td>${inv.date}</td><td><button class='delete-btn' onclick='deleteInvoice(${i})'>âŒ</button></td></tr>`).join("")+`</table>`;
}

const deleteInvoice = (i) => {
    let inv = invoices[i];
    let custIndex = customers.findIndex(c => c.name === inv.customer);
    if (custIndex !== -1) {
        customers[custIndex].trays =
            (customers[custIndex].trays || 0)
            + (inv.trays || 0)
            - (inv.empty || 0);
    }

    invoices.splice(i, 1);
    localStorage.setItem("customers", JSON.stringify(customers));
    localStorage.setItem("invoices", JSON.stringify(invoices));
    showInvoices();
    showCustomerReports();
}

// ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
const showCustomerReports = () => {
    if(customers.length===0) {
        customerReportsContent.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡.</p>";
        return;
    }
    let reportRows = customers.map(c => {
        return `<tr><td>${c.name}</td><td>${c.trays}</td></tr>`;
    }).join("");
    customerReportsContent.innerHTML = `<table><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø±ØµÙŠØ¯ Ø§Ù„ØµÙˆØ§Ù†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</th></tr>${reportRows}</table>`;
}

// Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§Ø±Øº Ù„Ù„ÙŠÙˆÙ…
const showEmptyTrays = () => {
    let today = new Date().toLocaleDateString('ar-EG');
    let totalEmptyToday = invoices
        .filter(inv => inv.date === today)
        .reduce((sum, inv) => sum + (inv.empty || 0), 0);
    emptyTraysContent.innerHTML = `<h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙˆØ§Ù†ÙŠ Ø§Ù„ÙÙˆØ§Ø±Øº Ù„Ù„ÙŠÙˆÙ… (${today}): ${totalEmptyToday}</h3>`;
}

// Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
const showSales = () => {
    let totalSales = invoices.reduce((sum,inv)=>sum+inv.total,0);
    let totalKilos = invoices.reduce((sum,inv)=>sum+(inv.net || 0),0);
    salesContent.innerHTML = `
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales.toFixed(2)} Ø¬Ù†ÙŠÙ‡</h3>
        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙŠÙ„Ùˆ Ø¬Ø±Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: ${totalKilos.toFixed(2)} ÙƒØ¬Ù…</h3>
    `;
}
</script>
</body>
</html>